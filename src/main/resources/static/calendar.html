<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜ˆì•½ ë‹¬ë ¥</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .today {
            animation: blink 1s infinite;
            font-weight: bold;
        }

        @keyframes blink {
            0% {
                background-color: #fff3cd;
            }
            50% {
                background-color: #ffeeba;
            }
            100% {
                background-color: #fff3cd;
            }
        }

        .disabled-day {
            pointer-events: none;
            color: #ccc;
        }

        .scroll-container {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
        }
    </style>
</head>
<body class="p-4">

<div class="d-flex justify-content-center mb-3">
    <button class="btn btn-outline-primary me-2" id="prevBtn">ì´ì „</button>

    <div id="monthButtons" class="btn-group" role="group"></div>

    <button class="btn btn-outline-primary ms-2" id="nextBtn">ë‹¤ìŒ</button>
</div>

<div id="daysContainer" class="d-flex flex-wrap mb-3"></div>

<h5>ğŸ“Œ ì„ íƒëœ ë‚ ì§œ: <span id="selectedDateText">ì—†ìŒ</span></h5>
<div id="postContainer" class="scroll-container"></div>

<script>
    const today = new Date();
    let currentYear = today.getFullYear();
    let currentMonth = today.getMonth(); // 0 ~ 11
    const loadedDates = new Set();
    let currentCenterDate = new Date(); // ê¸°ì¤€ì¼
    const monthNames = [...Array(12)].map((_, i) => `${i + 1}ì›”`);
    const monthButtons = document.getElementById('monthButtons');
    const daysContainer = document.getElementById('daysContainer');
    const selectedDateText = document.getElementById('selectedDateText');
    const postContainer = document.getElementById('postContainer');
    let isLoading = false;

    function renderMonthButtons() {
        monthButtons.innerHTML = '';
        monthNames.forEach((name, idx) => {
            const btn = document.createElement('button');
            btn.className = `btn ${idx === currentMonth ? 'btn-primary' : 'btn-outline-primary'}`;
            btn.textContent = name;
            btn.onclick = () => {
                currentMonth = idx;
                renderMonthButtons();
                renderDays();
            };
            monthButtons.appendChild(btn);
        });
    }

    function renderDays() {
        daysContainer.innerHTML = '';
        const date = new Date(currentYear, currentMonth, 1);
        const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();

        for (let day = 1; day <= lastDate; day++) {
            const fullDate = new Date(currentYear, currentMonth, day);
            const yyyyMMdd = formatDate(fullDate); // <-- ì´ê±¸ ì‚¬ìš©

            const dayBtn = document.createElement('button');
            dayBtn.className = 'btn btn-light m-1';
            dayBtn.textContent = day;

            if (fullDate.toDateString() === today.toDateString()) {
                dayBtn.classList.add('today');
            }

            if (fullDate < today.setHours(0, 0, 0, 0)) {
                dayBtn.classList.add('disabled-day');
            } else {
                dayBtn.onclick = () => {
                    selectedDateText.textContent = yyyyMMdd;
                    scrollToDate(yyyyMMdd); // âœ… ì´ ë¶€ë¶„
                    console.log("------------>" + selectedDateText.textContent)
                    // loadPosts(yyyyMMdd);
                };
            }

            daysContainer.appendChild(dayBtn);
        }
    }

    // ğŸ“Œ ê²Œì‹œê¸€ 1ì¼ì¹˜ ë¡œë”©
    async function loadPostsByDate(date, position = 'append') {
        const dateStr = formatDate(date);
        if (loadedDates.has(dateStr)) return;

        isLoading = true;

        const res = await fetch(`/api/posts/${dateStr}`);
        const data = await res.json();

        const wrapper = document.createElement('div');
        wrapper.className = 'mb-3';
        wrapper.id = `day-${dateStr}`

        wrapper.innerHTML = `<h6 class="text-secondary">${dateStr}</h6>`;
        if (date.toDateString() === today.toDateString()) {
            wrapper.style.backgroundColor = '#fff3cd';
            wrapper.style.border = '1px solid #ffc107';
            wrapper.style.padding = '10px';
        }

        data.forEach(post => {
            const div = document.createElement('div');
            div.innerHTML = `
                    <div style="height: 300px; overflow: hidden;">
                        <strong>${post.title}</strong><br>
                        <small>${post.content}</small>
                    </div>
                    <hr>`;
            wrapper.appendChild(div);
        });

        if (position === 'prepend') {
            postContainer.prepend(wrapper);
        } else {
            postContainer.appendChild(wrapper);
        }

        loadedDates.add(dateStr);
        isLoading = false;
    }
    // ğŸ”„ ì´ˆê¸° 10ì¼ì¹˜ ë¡œë”© (ì˜¤ëŠ˜ ê¸°ì¤€ Â±5ì¼)
    function loadInitialRange() {
        for (let i = -5; i <= 4; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            const position = i < 0 ? 'prepend' : 'append';
            loadPostsByDate(date, position);
        }

        // ì¤‘ì•™ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì¡°ì • (ì§€ì—° í›„)
        setTimeout(() => {
            const center = postContainer.scrollHeight / 2 - postContainer.clientHeight / 2;
            postContainer.scrollTop = center;
        }, 500);
    }

    // ë¬´í•œ ìŠ¤í¬ë¡¤ ì‹œ ë‹¤ë¥¸ ë‚ ì§œ ê²Œì‹œë¬¼ ë¡œë”© (ì˜ˆ: ë‹¤ìŒë‚ ì§œ)
    postContainer.addEventListener('scroll', () => {
        const top = postContainer.scrollTop;
        const bottom = postContainer.scrollHeight - postContainer.scrollTop - postContainer.clientHeight;

        if (!isLoading) {
            if (top < 100) {
                // ìŠ¤í¬ë¡¤ ìœ„: ì´ì „ ë‚ ì§œ ë¡œë”©
                const earliest = [...loadedDates].sort()[0];
                const prevDate = new Date(earliest);
                prevDate.setDate(prevDate.getDate() - 1);
                loadPostsByDate(prevDate, 'prepend');
            }

            if (bottom < 100) {
                // ìŠ¤í¬ë¡¤ ì•„ë˜: ë‹¤ìŒ ë‚ ì§œ ë¡œë”©
                const latest = [...loadedDates].sort().reverse()[0];
                const nextDate = new Date(latest);
                nextDate.setDate(nextDate.getDate() + 1);
                loadPostsByDate(nextDate, 'append');
            }
        }
    });
    // function loadPosts(dateStr) {
    //     postContainer.innerHTML = 'ë¡œë”© ì¤‘...';
    //     fetch(`/api/posts/${dateStr}`)
    //         .then(res => res.json())
    //         .then(data => {
    //             postContainer.innerHTML = '';
    //             data.forEach(post => {
    //                 const div = document.createElement('div');
    //                 div.innerHTML = `<b>${post.title}</b><br><small>${post.content}</small><hr>`;
    //                 postContainer.appendChild(div);
    //             });
    //         });
    // }

    // ì´ì „ / ë‹¤ìŒ ë²„íŠ¼
    document.getElementById('prevBtn').onclick = () => {
        currentMonth = (currentMonth - 1 + 12) % 12;
        renderMonthButtons();
        renderDays();
    };
    document.getElementById('nextBtn').onclick = () => {
        currentMonth = (currentMonth + 1) % 12;
        renderMonthButtons();
        renderDays();
    };


    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0'); // 1ì›” = 0
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    function scrollToDate(dateStr) {
        const el = document.getElementById(`day-${dateStr}`);
        if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            // í•´ë‹¹ ë‚ ì§œê°€ ì—†ìœ¼ë©´ ë¡œë“œí•˜ê³  ë‚˜ì„œ ì´ë™
            const dateObj = new Date(dateStr);
            loadPostsByDate(dateObj).then(() => {
                const newEl = document.getElementById(`day-${dateStr}`);
                if (newEl) {
                    newEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });function scrollToDate(dateStr) {
                const el = document.getElementById(`day-${dateStr}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    // í•´ë‹¹ ë‚ ì§œê°€ ì—†ìœ¼ë©´ ë¡œë“œí•˜ê³  ë‚˜ì„œ ì´ë™
                    const dateObj = new Date(dateStr);
                    loadPostsByDate(dateObj).then(() => {
                        const newEl = document.getElementById(`day-${dateStr}`);
                        if (newEl) {
                            newEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                }
            }
        }
    }
    renderMonthButtons();
    renderDays();
        loadInitialRange();


</script>

<style>
    .scroll-container {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
    }
</style>
</body>
</html>
